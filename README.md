# com.azure.cosmos.samples.eh_to_cdb
## Sample showing how to stream data from event hub into Cosmos DB
### Summary
This sample shows how a workload can ingest a large amount of data from an Azure EventHub source into Cosmos DB.

### Configuration
The sample uses various configuration options to determine authentication, how to connect to EventHub and various configs that can tune certain aspects of the workload based on the load/throughput requirements. These configuration options need to be set via Java system properties or environment variables - if both are specified the system property will be used. The ´Importance´ column expresses how important it is to set the configuration for this setting correctly - ´LOW´ means the setting is optional, and it is not expected that the default needs to be changed often. `HIGH` means this setting needs to be carefully evaluated depending on the workload - `REQUIRED` means the setting has to be specified.

| System property name                           | Environment variable name                      | Importance | Default value                      | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|------------------------------------------------|------------------------------------------------|------------|------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| COSMOS.ACCOUNT_ENDPOINT                        | COSMOS_ACCOUNT_ENDPOINT                        | REQUIRED   | n/a                                | The service endpoint - like https://<YOUR_ACCOUNT>.documents.azure.com for the sink                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| COSMOS.SINK_DB                                 | COSMOS_SINK_DB                                 | REQUIRED   | n/a                                | The name of the Cosmos DB database in which the data should be stored.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| COSMOS.SINK_COLLECTION                         | COSMOS_SINK_COLLECTION                         | REQUIRED   | n/a                                | The name of the collection in which the data should be stored. The partition key of this collection has to be `/pk`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| COSMOS.EVENTHUB_FULLY_QUALIFIED_NAMESPACE      | COSMOS_EVENTHUB_FULLY_QUALIFIED_NAMESPACE      | REQUIRED   | n/a                                | The EventHub fully qualified namespace. - like <YOUR_NAMESPACE>.servicebus.windows.net for the source.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| COSMOS.EVENTHUB_NAME                           | COSMOS_EVENTHUB_NAME                           | REQUIRED   | n/a                                | This will be the name of the Event Hub instance you created inside the Event Hubs namespace.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| COSMOS.IS_CONSOLE_RUN_MODE                     | COSMOS_IS_CONSOLE_RUN_MODE                     | REQUIRED   | n/a                                | A boolean flag to denote (like "true" or "false") whether the app is running in console mode. In console mode, the app will expect user interaction through a console.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| COSMOS.EVENTHUB_MAX_BATCH_SIZE                 | COSMOS_EVENTHUB_MAX_BATCH_SIZE                 | HIGH       | 5,000                              | The max. number of events from EventHub that should be tracked in a single batch. EventHub `bookmarks` (sequence numbers) will only be persisted for every batch. The higher this value the fewer overhead for persisting bookmarks - but also the risk of having to reprocess events in case of crashes etc. The higher the value, the more RU/s a single pod can saturate - but it also increases the memory footprint.                                                                                                                                                                                                                                                                                                                                                                                                   |
| COSMOS.EVENTHUB_PREFETCH_COUNT                 | COSMOS_EVENTHUB_PREFETCH_COUNT                 | HIGH       | 7,999                              | The max. number of events  which can be pre-fetched from EventHub per EventHub partition. The higher the value, the better the throughput - but also the memory footprint. The maximum value supported by the Azure EventHub SDK is 7,999.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| COSMOS.EVENTHUB_POLLING_INTERVAL_MS            | COSMOS_EVENTHUB_POLLING_INTERVAL_MS            | HIGH       | 250                                | Determines how long each EventHub partition processor waits at most before ingesting teh data into Cosmos DB even when the number of events available in EventHub is lower than `COSMOS_EVENTHUB_MAX_BATCH_SIZE`. The lower this value, the better the e2e latency - but it also increases the load on the EventHub.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| COSMOS.EVENTHUB_POSITION_COSMOS_COLLECTION     | COSMOS_EVENTHUB_POSITION_COSMOS_COLLECTION     | HIGH       | `EventHubPositions`                | The name of the collection in which EventHub bookmarks/positions should be persisted. The partition key of this collection has to be `/id`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| COSMOS.EVENTHUB_POSITION_REPORTING_INTERVAL_MS | COSMOS_EVENTHUB_POSITION_REPORTING_INTERVAL_MS | HIGH       | 60,000                             | The interval limits how often progress in the processing of an EventHub partition is getting persisted. The higher the value, the lower the overhead for reporting progress - but also the higher the risk of having to re-process messages in the case of crashes etc.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| COSMOS.EVENTHUB_INITIAL_EVENT_POSITION         | COSMOS_EVENTHUB_INITIAL_EVENT_POSITION         | HIGH       | `LATEST`                           | The initial EventHub position that should be used to start a stream for an EventHub partition. Possible values are `LATEST`, `EARLIEST` or any Timestamp that can be parsed as a `java.time.Instant`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| COSMOS.AAD_MANAGED_IDENTITY_ID                 | COSMOS_AAD_MANAGED_IDENTITY_ID                 | HIGH       | Auto-Discovery                     | The client-id of the managed identity to be used - if not specified picks one based on DefaultAzureCredential logic - if specified, it will always use that identity.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| COSMOS.AAD_TENANT_ID                           | COSMOS_AAD_TENANT_ID                           | HIGH       | Auto-Discovery                     | The AAD tenant id for the Azure resources and identities.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| COSMOS.ITEM_SERIALIZATION_INCLUSION_MODE       | COSMOS_ITEM_SERIALIZATION_INCLUSION_MODE       | HIGH       | `NonNull`                          | Determines whether null/default values will be serialized to json or whether properties with null/default value will be skipped. The behavior follows the same ideas as [Jackson's JsonInclude.Include](https://github.com/FasterXML/jackson-annotations/blob/d0820002721c76adad2cc87fcd88bf60f56b64de/src/main/java/com/fasterxml/jackson/annotation/JsonInclude.java#L98-L227). `Always` means json properties are created even for null and default values. `NonNull` means no json properties will be created for explicit null values. `NonEmpty` means json properties will not be created for empty string values or empty arrays/maps. `NonDefault` means json properties will be skipped not just for null/empty but also when the value is identical to the default value `0` for numeric properties for example. |
| COSMOS.EVENTHUB_POSITION_COSMOS_DB             | COSMOS_EVENTHUB_POSITION_COSMOS_DB             | LOW        | COSMOS_SINK_DB                     | The name of the Cosmos DB database in which the EventHub bookmarks/positions should be persisted.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| COSMOS.MAX_RETRY_COUNT                         | COSMOS_MAX_RETRY_COUNT                         | LOW        | 20                                 | The number of times transient failures for ingesting one specific document are going to be retried.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| COSMOS.AAD_LOGIN_ENDPOINT                      | COSMOS_AAD_LOGIN_ENDPOINT                      | LOW        | https://login.microsoftonline.com/ | Only needs to be modified in non-public Azure clouds.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| COSMOS.INITIAL_MICRO_BATCH_SIZE                | COSMOS_INITIAL_MICRO_BATCH_SIZE                | LOW        | 1                                  | The bulk ingestion feature in Cosmos DB allows streaming changes to the service by physical partition. This initial micro batch size determines the initial target size of a single request sent to a Cosmos DB partition. If the value is too high it could initially result in very high number of throttled requests - over time the sample will tune the micro batch size automatically to maintain a healthy throttling rate (enough to saturate the throughput without wasting too many resources on throttling.                                                                                                                                                                                                                                                                                                      |
| COSMOS.MAX_MICRO_BATCH_SIZE                    | COSMOS_MAX_MICRO_BATCH_SIZE                    | LOW        | 100                                | The maximum number of documents sent to the Cosmos DB service for a physical partition in a single request. Has to be between 1 and 100.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| COSMOS.CONNECTION_MODE                         | COSMOS_CONNECTION_MODE                         | LOW        | `GATEWAY`                          | The  connection mode which should be used when connecting to Cosmo DB. The possible values are `GATEWAY` (default) or `DIRECT`. The default value should be sufficient for this workload.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

### Running the sample

#### Preparation
1) Create the target container
   Create the container the data should be ingested in. Ensure the number of physical partitions created is high enough to accommodate the data being ingested. The explanation about how to achieve this is located [here](https://github.com/Azure/azure-sdk-for-java/blob/main/sdk/cosmos/azure-cosmos-spark_3_2-12/docs/scenarios/Ingestion.md#creating-a-new-container-if-the-ingestion-via-the-cosmos-spark-connector-is-for-the-initial-migration) -
   The sample expects that the container uses `/pk` as partition key - if you want to use a different partition key, some code changes will be required first. When creating the container please ensure the partition key definition is set to `/pk` and the indexing policy is updated to exclude as many properties as possible (each to-be-indexed property will add to the RU charge for write operations, so the fewer properties are indexed, the lower the RU charge for each write operation).
   The ideal index policy for the target container would look like this:

```json
{
    "indexingMode": "consistent",
    "automatic": true,
    "includedPaths": [
        
    ],
    "excludedPaths": [
        {
            "path": "/*"
        },
        {
            "path": "/\"_etag\"/?"
        }
    ]
}
```

2) Create the EventHub positions container to use for tracking the processing status for each EventHub partition in the respective ConsumerGroup. This container has to use a partition key definition of `/id` - and the standard indexing policy should be used.

3) Specify the environment variables or JVM system properties according to the (Configuration)[#Configuration] section above.

#### Building the application
You can use `mvn package` to build the jar file. The application will produce a fat-jar (one single jar file containing all dependencies). This file will be located in the target folder and have a name similar to `eh-to-cdb-1.0-SNAPSHOT-jar-with-dependencies.jar`.

#### Starting the processing for a set of partitions
Each VM/pod/client would usually be responsible only for processing a subset of EventHub partitions.

To start the processing - run the following command line
```
java -cp ./eh-to-cdb-1.0-SNAPSHOT-jar-with-dependencies.jar com.azure.cosmos.samples.eh_to_cdb.Main <Consumer_Group> <PartitionId_1>#<PartitionId_2>#<PartitionId_3>
```

Instead of `<Consumer_group>` use a unique identifier for your stream - each value will track the progress of processing in EventHub independently. The `<PartitionId_*>` term defines the EventHub partitions that should be processed by this processor (separated by `#` character).

### Very high level design description
For each EventHub partition one instance of `com.azure.cosmos.samples.eh_to_cdb.EventHubPartitionProcessor` is created to process just the events of this EventHub partition. For each EventHub partition up-to `COSMOS_EVENTHUB_PREFETCH_COUNT` events can be pre-fetched locally - and will be ingested into cosmos in batches of up-to `COSMOS_EVENTHUB_MAX_BATCH_SIZE` documents (or every 100ms). Processing the batch is done by invoking the upsertAll operation in `DocumentBulkExecutor`. For each method invocation - tracking the ingestion of all documents of this batch is captured in `DocumentBulkExecutorOperationStatus`. Here status like the number of successfully ingested documents, the number of outstanding operations, any failures (exceeding the defined retry count) etc. is captured. Each of tehse batches will/could write to all Cosmos DB physical partitions - so event a few EventHub partitions would be able to saturate the Cosmos DB RU/s throughput. The end-to-end throughput should be bottle-necked by the RU/s provisioned in Cosmos DB - meaning the RU/s in Cosmos DB should be fully saturated - if the throughput is constrained anywhere else, this would indicate a configuration problem in the streaming process.
Each worker will process a configurable number of EventHub partitions - the higher, the more documents can be processed per machine - as long as the machine is not overloaded (monitor CPU/memory).



